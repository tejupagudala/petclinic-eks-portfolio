# .github/workflows/ci.yaml
name: vets-service-ci

on:
  pull_request:
    branches: [ main ]
    paths:
      - "app/**"
      - "kubernetes/vets-service/**"
      - ".github/workflows/ci.yaml"
  push:
    branches: [ main, githubcicheck ]
    paths:
      - "app/**"
      - "kubernetes/vets-service/**"
      - ".github/workflows/ci.yaml"

permissions:
  contents: write

env:
  SERVICE_NAME: vets-service
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/vets-service

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build (skip tests)
        run: |
          cd app
          if [ -f "./mvnw" ]; then MVN="./mvnw"; else MVN="mvn"; fi
          $MVN -pl spring-petclinic-vets-service -am clean package -DskipTests

      - name: Unit tests
        run: |
          cd app
          if [ -f "./mvnw" ]; then MVN="./mvnw"; else MVN="mvn"; fi
          $MVN -pl spring-petclinic-vets-service -am test

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Verify (runs plugins if configured)
        run: |
          cd app
          if [ -f "./mvnw" ]; then MVN="./mvnw"; else MVN="mvn"; fi
          $MVN -pl spring-petclinic-vets-service -am verify

  docker:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: app
          file: app/spring-petclinic-vets-service/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ github.run_id }}
            ${{ env.DOCKER_IMAGE }}:latest

  updatek8s:
    runs-on: ubuntu-latest
    needs: [build, docker, code-quality]
    # Intentionally run only on push (not pull_request) to avoid write attempts from PR contexts.
    if: needs.docker.result == 'success' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tag in k8s deployment manifest
        run: |
          FILE="kubernetes/vets-service/deployment.yaml"
          if [ ! -f "$FILE" ]; then
            echo "ERROR: $FILE not found."
            exit 1
          fi
          sed -i "s|image: .*vets-service:.*|image: ${{ env.DOCKER_IMAGE }}:${{ github.run_id }}|g" "$FILE"

      - name: Commit and push changes
        run: |
          git config --global user.email "teju.654@gmail.com"
          git config --global user.name "tejupagudala"
          git add kubernetes/vets-service/deployment.yaml
          git commit -m "[CI]: Update vets-service image tag to ${{ github.run_id }}" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}
